<!DOCTYPE html>
<html>
<head>
    <title>VR</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0, shrink-to-fit=no">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
    <meta name="description" content="VR" />
    <script src="Scripts/three.js"></script>
    <script src="Scripts/js/webVR/webvr-polyfill.min.js"></script>
    <script src="Scripts/js/webVR/VRControls.js"></script>
    <script src="Scripts/js/webVR/VREffect.js"></script>
    <script src="Scripts/js/webVR/cardboard-vr-display.js"></script>

    <script src="Scripts/js/libs/inflate.min.js"></script>
    <script src="Scripts/js/loaders/FBXLoader.js"></script>
    <script src="Scripts/js/controls/OrbitControls.js"></script>
    <script src="Scripts/js/Detector.js"></script>
    <script src="Scripts/js/libs/stats.min.js"></script>
    <style type="text/css">
        body {
            width: 100%;
            height: 100%;
            background-color: #000;
            color: #fff;
            margin: 0px;
            padding: 0;
            overflow: hidden;
        }

        canvas {
            position: absolute;
            top: 0;
        }

        #buttons {
            position: fixed;
            top: 0;
            right: 0;
            z-index: 1;
            background: white;
        }
    </style>
</head>
<body>
    <div id="buttons">
        <button id="fullscreen">Fullscreen</button>
        <button id="vr">VR (WebVR/Mobile only)</button>
        <button id="reset">Reset</button>
    </div>
    <script>
         var config = (function () {
            var config = {};
            var q = window.location.search.substring(1);
            if (q === '') {
                return config;
            }
            var params = q.split('&');
            var param, name, value;
            for (var i = 0; i < params.length; i++) {
                param = params[i].split('=');
                name = param[0];
                value = param[1];

                // All config values are either boolean or float
                config[name] = value === 'true' ? true :
                    value === 'false' ? false :
                        parseFloat(value);
            }
            return config;
        })();

        // Mock VRFrameData for VRControls
        function VRFrameData() {
            this.leftViewMatrix = new Float32Array(16);
            this.rightViewMatrix = new Float32Array(16);
            this.leftProjectionMatrix = new Float32Array(16);
            this.rightProjectionMatrix = new Float32Array(16);
            this.pose = null;
        };


        console.log('creating CardboardVRDisplay with options', config);
        var vrDisplay = new CardboardVRDisplay(config);

        // If loading this inside of an iframe (see iframe.html),
        // force using the `devicemotion` sensor fusion, rather than
        // newer Generic Sensors due to an issue with sensors
        // in iframes in Chrome < m69:
        // https://bugs.chromium.org/p/chromium/issues/detail?id=849501
        if (window.self !== window.top) {
            vrDisplay.poseSensor_.useDeviceMotion();
        }

        navigator.getVRDisplays = function () {
            return new Promise(function (resolve) {
                resolve([vrDisplay]);
            });
        };


        // Setup three.js WebGL renderer. Note: Antialiasing is a big performance hit.
        // Only enable it if you actually need to.
        var renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setPixelRatio(Math.floor(window.devicePixelRatio));

        // Append the canvas element created by the renderer to document body element.
        document.body.appendChild(renderer.domElement);

        // Create a three.js scene.
        var scene = new THREE.Scene();
        scene.background = new THREE.Color(0xe9e9e9);

        // Create a three.js camera.
        var camera = new THREE.PerspectiveCamera(30, window.innerWidth / window.innerHeight, 1, 9000);
        camera.position.set(100, 200, 3000);

        // Create a reticle
        var reticle = new THREE.Mesh(
            new THREE.RingBufferGeometry(0.005, 0.01, 15),
            new THREE.MeshBasicMaterial({ color: 0xffffff })
        );


        // Apply VR headset positional data to camera.
        var controls = new THREE.VRControls(camera);

        // Apply VR stereo rendering to renderer.
        var effect = new THREE.VREffect(renderer);
        effect.setSize(window.innerWidth, window.innerHeight);

        var light = new THREE.HemisphereLight(0x444444, 0xffffff);
        light.position.set(0, 200, 0);
        scene.add(light);

        var light = new THREE.DirectionalLight(0xffffff);
        light.position.set(0, 290, 100);
        light.castShadow = false;
        light.shadow.camera.top = 1080;
        light.shadow.camera.bottom = -100;
        light.shadow.camera.left = -1520;
        light.shadow.camera.right = 3020;
        scene.add(light);

        var loader = new THREE.FBXLoader();
        loader.load('models/fbx/SingaporeBuilding_NoRoof.fbx', function (object) {

            object.traverse(function (child) {

                if (child.isMesh) {

                    child.castShadow = true;
                    child.receiveShadow = true;

                }

            });

            scene.add(object);

        });
        // Kick off the render loop.
        vrDisplay.requestAnimationFrame(animate);



        // Request animation frame loop function
        function animate(timestamp) {


            // Update VR headset position and apply to camera.
            controls.update();

            // Render the scene.
            effect.render(scene, camera);

            // Keep looping.
            vrDisplay.requestAnimationFrame(animate);
        }

        function onResize() {
            console.log('Resizing to %s x %s.', window.innerWidth, window.innerHeight);
            effect.setSize(window.innerWidth, window.innerHeight);
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
        }

        function onVRDisplayPresentChange() {
            console.log('onVRDisplayPresentChange');
            onResize();
        }

        // Resize the WebGL canvas when we resize and also when we change modes.
        window.addEventListener('resize', onResize);
        window.addEventListener('vrdisplaypresentchange', onVRDisplayPresentChange);

        // Button click handlers.
        document.querySelector('button#fullscreen').addEventListener('click', function () {
            enterFullscreen(renderer.domElement);
        });
        document.querySelector('button#vr').addEventListener('click', function () {
            vrDisplay.requestPresent([{ source: renderer.domElement }]);
        });
        document.querySelector('button#reset').addEventListener('click', function () {
            vrDisplay.resetPose();
        });

        function enterFullscreen(el) {
            if (el.requestFullscreen) {
                el.requestFullscreen();
            } else if (el.mozRequestFullScreen) {
                el.mozRequestFullScreen();
            } else if (el.webkitRequestFullscreen) {
                el.webkitRequestFullscreen();
            } else if (el.msRequestFullscreen) {
                el.msRequestFullscreen();
            }
        }


    </script>
</body>
</html>

